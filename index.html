<script type="module">

// ğŸ”¥ IMPORTS CORRETOS PARA HTML
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, collection, getDocs }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// ğŸ”‘ SUA CONFIG (a que vocÃª mandou)
const firebaseConfig = {
  apiKey: "AIzaSyBIhdaoUVn15NHkOMSVCqIe2KyduVqo1vc",
  authDomain: "myproject-68706.firebaseapp.com",
  projectId: "myproject-68706",
  storageBucket: "myproject-68706.firebasestorage.app",
  messagingSenderId: "283715328094",
  appId: "1:283715328094:web:2227ab06853a1a2dd9fccf",
  measurementId: "G-V69Z81H288"
};

// ğŸš€ Inicializa Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

let user;
let agendamentoSalvo = null;

// ğŸ” Login automÃ¡tico
onAuthStateChanged(auth, async (u)=>{
    if(u){
        user = u;
        verificarAgendamento();
        carregarHorarios();
    }else{
        await signInWithPopup(auth, provider);
    }
});

// ğŸ” Verifica se jÃ¡ tem agendamento salvo
async function verificarAgendamento(){
    const ref = doc(db, "agendamentos", user.uid);
    const snap = await getDoc(ref);

    if(snap.exists()){
        agendamentoSalvo = snap.data();
        alert("VocÃª jÃ¡ tem um agendamento salvo!");
    }
}

// ğŸ“… Carrega horÃ¡rios
async function carregarHorarios(){

    const horariosDiv = document.getElementById("horarios");
    horariosDiv.innerHTML="";

    const querySnap = await getDocs(collection(db,"agendamentos"));
    let ocupados = [];

    querySnap.forEach(doc=>{
        ocupados.push(doc.data().hora + "-" + doc.data().dia);
    });

    const diasSemana=["Dom","Seg","Ter","Qua","Qui","Sex","SÃ¡b"];
    let hoje = diasSemana[new Date().getDay()];

    for(let h=8;h<=19;h++){
        for(let m of ["00","30"]){

            if(h===19 && m==="30") continue;

            let hr=`${h.toString().padStart(2,"0")}:${m}`;
            let chave = hr+"-"+hoje;

            let el=document.createElement("div");
            el.className="hour";
            el.innerText=hr;

            if(ocupados.includes(chave)){
                el.style.opacity="0.3";
            }else{
                el.onclick=()=>agendar(hoje,hr);
            }

            horariosDiv.appendChild(el);
        }
    }
}

// ğŸ“ Salvar agendamento
async function agendar(dia,hora){

    if(agendamentoSalvo){
        alert("VocÃª jÃ¡ possui agendamento!");
        return;
    }

    const ref = doc(db, "agendamentos", user.uid);

    await setDoc(ref,{
        nome:user.displayName,
        email:user.email,
        dia:dia,
        hora:hora
    });

    alert("Agendamento confirmado!");
    location.reload();
}

</script>
